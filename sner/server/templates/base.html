<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="csrf-token" content="{{ csrf_token() }}">
	<title>sner4 - {% block title %}{% endblock %}</title>


	<script type="text/javascript" src="{{ url_for('static', filename='jquery/jquery-3.2.1.min.js') }}"></script>

	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='bootstrap/css/bootstrap.min.css') }}" />
	<script type="text/javascript" src="{{ url_for('static', filename='bootstrap/js/bootstrap.min.js') }}"></script>

	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='toastr/toastr.min.css') }}" />
	<script type="text/javascript" src="{{ url_for('static', filename='toastr/toastr.min.js') }}"></script>

	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='datatables/dataTables.bootstrap.min.css') }}" />
	<script type="text/javascript" src="{{ url_for('static', filename='datatables/jquery.dataTables.min.js') }}"></script>
	<script type="text/javascript" src="{{ url_for('static', filename='datatables/dataTables.bootstrap.min.js') }}"></script>
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='datatables/select.dataTables.min.css') }}" />
	<script type="text/javascript" src="{{ url_for('static', filename='datatables/dataTables.select.min.js') }}"></script>

	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='tageditor/jquery.tag-editor.css') }}" />
	<script type="text/javascript" src="{{ url_for('static', filename='tageditor/jquery.caret.min.js') }}"></script>
	<script type="text/javascript" src="{{ url_for('static', filename='tageditor/jquery.tag-editor.min.js') }}"></script>

	<script type="text/javascript" src="{{ url_for('static', filename='handlebars/handlebars.min.js') }}"></script>

	<style>
		/* menu image */
		.navbar-brand { padding: 0px; }
		.navbar-brand img { height: 100%; padding: 5px; width: auto; }

		/* required items on forms */
		label.control-label.required:after { content:"*"; color:red; }

		/* tag-editor same borders as other bootstraped input */
		.tag-editor { border: 1px solid #ccc; border-radius: 4px; }

		/* note data may contain very long unwrapable data */
		.forcewrap { word-wrap: break-word; word-break: break-all; white-space: normal; }

		/* dt styling */
		.dataTables_wrapper, .dt_toolbar { margin-top: 5px; margin-bottom: 5px; }
		td.dt-nowrap { white-space: nowrap; }
		.text-alert { color: red; }
	</style>


	{{ JSGlue.include() }}

	<script type="text/javascript">
		// ui helpers and callbacks
		//

		/*
		 * will rerender element with hbs acording to data attributes
		 *  - data-hbs (hbs compiled template)
		 *  - data-hbs_context (json context for the template)
		 * @param {DOMElement} elem - element to rerender
		 */
		function render_hbs(elem) {
			var hbs = elem.getAttribute('data-hbs');
			var context = JSON.parse(elem.getAttribute('data-hbs_context'));
			elem.innerHTML = window[hbs](context);
		}

		/*
		 * sner submit form
		 */
		function sner_submit_form(url, data={}) {
			data['csrf_token'] = $('meta[name="csrf-token"]').attr('content');
			return $.ajax({"url": url,"type": "POST", "data": data})
				.fail(function(xhr, status, exception) { toastr.error(xhr.responseJSON["title"]); });
		}

		/*
		 * action select all from table
		 */
		function action_selectall(event) { event.data.dt.rows(null, {'page': 'current'}).select(); }

		/*
		 * action select none from dt
		 */
		function action_selectnone(event) { event.data.dt.rows(null, {'page': 'current'}).deselect(); }

		/*
		 * action tag multiple items
		 * @param {object} event - event with data {'dt': datatable instance, 'tag': string}
		 */
		function action_tag_by_id(event) {
			var data = {'tag': event.target.getAttribute('data-tag')};

			var ids = dt_get_selected_ids(event.data.dt);
			for (var i = 0; i < ids.length; i++) { data['ids-'+i] = ids[i]; }

			sner_submit_form(event.data.url, data)
				.always(function() { event.data.dt.draw(); });
		}

		/*
		 * action delete multiple items
		 * @param {object} event - event with data {'dt': datatable instance}
		 */
		function action_delete_by_id(event) {
			if (!confirm('Really delete?')) { return; }

			var data = {};
			var ids = dt_get_selected_ids(event.data.dt);
			for (var i = 0; i < ids.length; i++) { data['ids-'+i] = ids[i]; }

			sner_submit_form(event.data.url, data)
				.always(function() { event.data.dt.draw(); });
		}

		/*
		 * action delete by url
		 * @param {object} event - optional; event with data {'dt': datatable instance}
		 */
		function action_delete_by_url(event) {
			if (!confirm('Really delete?')) { return; }

			sner_submit_form(event.target.closest('a').getAttribute('data-url'))
				.always(function() { event.data.dt.draw(); });
		}


		/// ajaxed datatables helpers
		///
		/*
		 * datatables select helper, returns array of selected rows/data ids
		 * @param {object} dt - datatable instance
		 */
		function dt_get_selected_ids(dt) {
			// would use .map return item[x], but it does not cleanup other row attrs
			var ids = [];
			dt.rows({'selected': true}).data().each(function(item) { ids.push(item['id']) });
			return ids;
		};

		/*
		 * datatables helper, toggles pagination if needed
		 * @param {object} dt - datatable instance
		 */
		function dt_toggle_pagination(dt) {
			var pagination = $('#'+dt.table().node().id+'_wrapper .dataTables_paginate');
			if (dt.page.info().pages <= 1) { pagination.hide(); } else { pagination.show();	}
		}

		/**
		 * datatables helper, generate object of basic column options and non-html rendering
		 * @param {string} d - column name
		 * @param {object} extra - extra data to inject into column definition
		 */
		function dt_column(d, extra={}) {
			return $.extend({"name": d, "title": d, "data": d, "render": $.fn.dataTable.render.text()}, extra);
		}

		/**
		 * datatables helper, generate _select column definition
		 */
		function dt_column_select() { return {'name': '_select', 'title': '', 'data': null, 'defaultContent': '', 'orderable': false, 'className': 'select-checkbox'}; }

		/**
		 * datatables helper, generate _select column definition
		 * @param {callback} render - function to render cell, typically compiled hbs template
		 */
		function dt_column_buttons(render_callback=null, extra={}) {
			return $.extend({'name': '_buttons', 'title': '_buttons', 'data': '_buttons', 'orderable': false, 'className': 'dt-nowrap', 'render': function (data, type, row, meta) { return render_callback(row); }}, extra);
		}

		/**
		 * datatables helper, default ajax enhanced dt options
		 */
		var dt_ajax_options = {
			"serverSide": true,
			"processing": true,

			'dom': '<"row"<"col-sm-6"l><"col-sm-6"f>> <"row"<"col-sm-12"p>> <"row"<"col-sm-12"rt>> <"row"<"col-sm-6"i><"col-sm-6"p>>',
			'info': true,
			'paging': true,
			'pageLength': 10,
			'stateSave': true,
			'stateDuration': -1,

			"drawCallback": function (settings) {
				dt_toggle_pagination(this.api());
				this.find('td a.abutton_delete_by_url').on('click', {'dt': this.api()}, action_delete_by_url);
			}
		};



		// simple static static datatables
		//
		var datatable_static_options = {
			'columnDefs': [ {
				'targets': 'no-sort',
				'orderable': false,
			} ],
			'order': [[ 0, 'asc' ]],
			'paging': false,
			'info': false
		};



		// common startups
		//
		$(document).ready(function() {
			if (typeof datatable_static_custom !== 'undefined') {
				datatable_static_options = $.extend({}, datatable_static_options, datatable_static_custom);
			}
			$('.datatable_static').DataTable(datatable_static_options);

			$('.tageditor').tagEditor({'delimiter': '\n'});
			$('.render_hbs').each(function(index, elem) { render_hbs(elem); });
		});
	</script>


	{% include 'auth/pageparts.html' %}
	{% include 'scheduler/pageparts.html' %}
	{% include 'storage/pageparts.html' %}

	{% block style %}{% endblock %}
	{% block script %}{% endblock %}
</head>
<body>
	<nav class="navbar navbar-default">
	<div class="container-fluid">
        	<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="{{ url_for('index_route') }}"><img src="{{ url_for('static', filename='logo.png') }}"></a>
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav">
				<li><a href="{{ url_for('scheduler.excl_list_route') }}">sch:Exclusions</a></li>
				<li><a href="{{ url_for('scheduler.task_list_route') }}">sch:Tasks</a></li>
				<li><a href="{{ url_for('scheduler.queue_list_route') }}">sch:Queues</a></li>
				<li><a href="{{ url_for('scheduler.job_list_route') }}">sch:Jobs</a></li>
				<li><a href="{{ url_for('storage.host_list_route') }}">st:Hosts</a></li>
				<li><a href="{{ url_for('storage.service_list_route') }}">st:Services</a></li>
				<li><a href="{{ url_for('storage.vuln_list_route') }}">st:Vulns</a></li>
				<li><a href="{{ url_for('storage.vuln_grouped_route') }}">st:Vulns grouped</a></li>
				<li><a href="{{ url_for('storage.note_list_route') }}">st:Notes</a></li>
				<li><a href="{{ url_for('storage.host_vizdns_route') }}">st:Hosts:vizdns</a></li>
				<li><a href="{{ url_for('storage.service_vizports_route') }}">st:Services:vizports</a></li>
			</ul>

			<ul class="nav navbar-nav navbar-right">
			{% if not current_user.is_authenticated %}
				<li><a href="{{ url_for('auth.login_route') }}">Login</a></li>
			{% else %}
				<li class="dropdown">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown">
						<span class="glyphicon glyphicon-user"></span>
						<strong>{{ current_user.username }}</strong>
						<span class="glyphicon glyphicon-chevron-down"></span>
					</a>
					<ul class="dropdown-menu">
						<li><a href="{{ url_for('auth.user_list_route') }}">Users</a></li>
						<li><a href="{{ url_for('auth.logout_route') }}">Logout</a></li>
					</ul>
				</li>
			{% endif %}
			</ul>
		</div><!--/.nav-collapse -->
	</div>
	</nav>

	<div class="container-fluid">
		{% block content %}
		{% endblock %}
	</div>

	<script type="text/javascript">
		toastr.options = {
			"positionClass": "toast-top-right",
		};
		{% for category, message in get_flashed_messages(with_categories=true) %}
		toastr['{{ category }}']('{{ message }}');
		{% endfor %}
	</script>
</body>
</html>
